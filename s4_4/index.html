<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>BRA-LIN-S4.4 - BRA-LIN-S4</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "BRA-LIN-S4.4";
        var mkdocs_page_input_path = "s4_4.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> BRA-LIN-S4
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../s4_1/">BRA-LIN-S4.1</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../s4_2/">BRA-LIN-S4.2</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../s4_3/">BRA-LIN-S4.3</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="./">BRA-LIN-S4.4</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#software-development">Software development</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#roadmap-for-the-development-phase">Roadmap for the development phase</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#planning-for-operations">Planning for operations</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#stage-i-data-acquisition">Stage I   - Data acquisition</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#stage-ii-photo-z-pre-processing">Stage II  - Photo-z pre-processing</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#stage-iii-photo-z-computing">Stage III - Photo-z computing</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#stage-iv-photo-z-post-processing">Stage IV - Photo-z post-processing</a>
    </li>
        </ul>
    </li>
    </ul>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">BRA-LIN-S4</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
      <li>BRA-LIN-S4.4</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h2 id="s44-pz-tables-as-federated-datasets">S4.4 - PZ Tables as Federated Datasets</h2>
<h3 id="introduction">Introduction</h3>
<p>The Legacy Survey of Space and Time (LSST) will provide photometric measurements for billions of objects during its ten years of operations. Most foreseen LSST science cases rely on photometric redshifts (photo-z) estimates for these objects. </p>
<p>The LSST Project's Data Management (DM) department plans to provide at least one, possibly more, photo-z estimates for each object as part of each data release. Given the large and diverse scope of science that can result from the LSST data, a unique photo-z method is expected not to satisfy all the requirements of the whole community. </p>
<p>This contribution consists of offering photo-z tables as federated datasets for each data release, using a different photo-z method from the official estimates (to be defined by the DM team), thus expanding the scope of the science supported by the data releases. </p>
<p>The infrastructure required to produce, store, and deliver the photo-z tables will be provided by the Brazilian IDAC. The software development necessary to produce these tables, including the optimization and refactoring of the DES photo-z pipelines to run on the LSST scale and the production of new pipelines to cover all data flow steps, is accounted for as a directable software development effort. </p>
<h3 id="software-development">Software development</h3>
<p>The initial software development plan consisted of refactoring the pipeline Photo-z Compute from the DES Science Portal to ensure scalability in LSST. The new pipeline would keep only the concepts of data preparation, parallelization, easy access to metadata, and provenance control. The LSST scale imposes the adoption of a completely different technology from that used in the DES Portal.</p>
<p>Preliminary tests using Parsl to handle the parallelization and using the photo-z code <a href="https://www.cfht.hawaii.edu/~arnouts/LEPHARE/lephare.html" target="_blank">LePHARE</a> were carried out in 2021-2022. In mid-2022, the development team started an investigation to evaluate the possibility of reusing <a href="https://github.com/LSSTDESC/RAIL" target="_blank">RAIL</a> (open source code, developed by DESC) infrastructure to support the production of photo-z tables. </p>
<p>An initial set of scripts to automatize the preparation of input data and the execution of the RAIL estimate module at LIneA's HPC environment is available on the <a href="https://github.com/linea-it/pz-compute" target="_blank">PZ Compute's repository on GitHub</a>. It supports two photo-z algorithms: BPZ and FlexZBoost. LIneA team will contribute to RAIL development by implementing the wrapper of the photo-z algorithm recommended by DM if it still needs to be implemented at the time.</p>
<p>Scalability tests using the initial version of the pipeline on <a href="https://dp0-2.lsst.io/" target="_blank">DP0.2 data</a> yielded the first runtime and storage benchmarks. A detailed report with test results is available in <a href="https://docs.google.com/document/d/1a1_vLTTuf866ZdcPIJTaKzLk8Ih1w11OfzIdp4DGuYg/preview" target="_blank">this document</a>. Some highlights are: </p>
<ul>
<li>For 40 billion objects, around 267 thousand files are expected.</li>
<li>Uncompressed output files with 301 points would take around 344 MiB.</li>
<li>The result of estimating 40 billion objects would take around 88 TiB.</li>
<li>12 column pre-processed input files with magnitude data would take around 14 MiB each, 3,5 TiB for DR11 (40 billion objects).</li>
</ul>
<table>
<thead>
<tr>
<th align="left">Algorithm</th>
<th align="center">Average time per object</th>
<th align="center">Predicted Runtime for DR11</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">Pr√©-processing</td>
<td align="center">0.03 ms/obj</td>
<td align="center">00:23:52</td>
</tr>
<tr>
<td align="left">BPZ</td>
<td align="center">1.95 ms/obj</td>
<td align="center">33:30:28</td>
</tr>
<tr>
<td align="left">FlexZBost</td>
<td align="center">2.70 ms/obj</td>
<td align="center">24:10:45</td>
</tr>
</tbody>
</table>
<h4 id="roadmap-for-the-development-phase">Roadmap for the development phase</h4>
<ul>
<li>Development of scripts to automatize data integrity tests after the data transfer. </li>
<li>Development of scripts to automatize the creation of skinny tables (lightweight input tables). </li>
<li>Development of Jupyter notebooks to perform PZ training and validation. </li>
<li>Development of scripts to automatize the execution of RAIL with parallelization in HPC Cluster</li>
<li>Development of pipeline PZ Compute's code profiler and process monitoring</li>
<li>Scalability tests using the IDAC's infrastructure (Apolo computer cluster and the supercomputer Santos Dumont)</li>
<li>Integration tests - E2E pre-operations using data previews DP0.2, DP1, DP2 </li>
<li>Wrapping new photo-z codes into RAIL (if necessary). </li>
<li>Performance tests - comparing codes (using DP1 and DP2). </li>
</ul>
<h3 id="planning-for-operations">Planning for operations</h3>
<p>The figure below shows a flowchart representing the data flow within the Brazilian IDAC infrastructure. The numbered arrows refer to the sequence of processes that involves moving data through the IDAC components. The roman numbers refer to processes involving data transformation. </p>
<p><img alt="Sequence of steps for PZ Compute" src="../IDAC_dataflow.png" /></p>
<p>The steps involved in the production of PZ tables are organized in four stages: </p>
<h4 id="stage-i-data-acquisition">Stage I   - Data acquisition</h4>
<ul>
<li>Register new data release (DR) on the IDAC data management system (initial metadata). </li>
<li>Start data transfer: download LSST Objects Catalog files from LSST Data Access Center (DAC) to LIneA's Data Transfer Node in DMZ. The following steps are done continuously as new chunks of data arrive. </li>
<li>Save Objects Catalog files on Lustre T1.</li>
<li>Objects Catalog automatic validation of chunks of data - integrity and consistency checks, QA reports, and compare key numbers. Append QA info to DR metadata. </li>
<li>Apply data cleaning to create a "skinny table" for input for photo-z pipelines (e.g., select columns, truncate extra decimal cases, etc). Save skinny table on Lustre T0. Append skinny table info to DR metadata.</li>
<li>Download and store ancillary files (e.g., observing conditions maps, SED templates, documents, etc). Append ancillary file info to DR metadata.</li>
</ul>
<h4 id="stage-ii-photo-z-pre-processing">Stage II  - Photo-z pre-processing</h4>
<ul>
<li>Execution of pipeline Training Set Maker (or download whatever training set recommended by the LSST DM team).</li>
<li>Characterization of the training set - QA report (Jupyter Notebook).</li>
<li>Register (and upload) training set(s) on the PZ Server.</li>
<li>Photo-z Validation: execution of RAIL <code>inform</code>, <code>estimation</code>, and <code>evaluation</code> modules. Report with photo-z quality metrics (Jupyter Notebook).</li>
<li>Obtain report approval from Rubin DM Photo-z Coord. </li>
<li>Register (and upload) PZ validation results on the PZ Server.</li>
</ul>
<h4 id="stage-iii-photo-z-computing">Stage III - Photo-z computing</h4>
<ul>
<li>Execution of pipeline PZ Compute (based on RAIL estimation module, customized to run in parallel using the IDAC's * infrastructure) on the whole dataset. </li>
<li>Validation of PZ Compute results - Report with metadata, priors, configuration parameters, global statistics, N(z) (global and tomographic bins) (Jupyter Notebook). </li>
<li>Register (no upload, only metadata) the PZ table on the PZ Server. </li>
</ul>
<h4 id="stage-iv-photo-z-post-processing">Stage IV - Photo-z post-processing</h4>
<ul>
<li>Data preparation for upload (compress files, prepare a package with reports and metadata). Move the PZ table to LIneA's Data Transfer Node in DMZ. </li>
<li>Deliver PZ tables (data transfer from BR IDAC to US DAC or Cloud). </li>
<li>Register on RSP as a federated dataset. Make the table stored in USDF available for RSP users. </li>
</ul>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../s4_3/" class="btn btn-neutral float-left" title="BRA-LIN-S4.3"><span class="icon icon-circle-arrow-left"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../s4_3/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
